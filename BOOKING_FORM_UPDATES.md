# تحديثات نموذج الحجز الداخلي

## التحديثات الجديدة - 23 نوفمبر 2025

### 1. إعادة تنظيم النموذج

تم تنظيم نموذج الحجز الداخلي بشكل أفضل مع فصل واضح بين الأقسام:

#### الترتيب الجديد:

1. **رقم الغرفة** (في الأعلى)
2. **السيارة**
   - نوع السيارة (باص، كوستر، الخ)
   - السيارة (مع التحقق من التوفر)

3. **قسم الذهاب** (خلفية زرقاء)
   - السائق
   - التاريخ والوقت
   - مدة الرحلة (بالدقائق)
   - التشغيلة (نص حر: من - إلى)

4. **عدد الأفراد**

5. **قسم العودة** (خلفية برتقالية)
   - سائق العودة
   - التاريخ والوقت
   - مدة رحلة العودة (بالدقائق)
   - التشغيلة العودة (نص حر، اختياري)

6. **نوع الدفع**
   - كاش
   - فيزا
   - أجل

7. **المبالغ المالية**
   - التكلفة
   - سعر الحجز
   - العملة

---

### 2. التشغيلة كنص حر

**قبل:** كانت التشغيلة عبارة عن اختيار من قائمة مواقع محددة مسبقاً

**الآن:** 
- حقل نص حر يمكن كتابة التشغيلة مباشرة
- مثال: "من فندق ماريوت إلى الأهرامات"
- للذهاب: **مطلوب**
- للعودة: **اختياري** (يمكن تركه فارغاً إذا كانت نفس تشغيلة الذهاب بالعكس)

**الحقول الجديدة:**
- `departure_route` - تشغيلة الذهاب (text)
- `return_route` - تشغيلة العودة (text, nullable)

---

### 3. مدة الرحلة

تم إضافة حقل جديد لتسجيل مدة كل رحلة بالدقائق:

**للذهاب:**
- حقل: `trip_duration`
- مثال: 40 دقيقة
- **مطلوب**

**للعودة:**
- حقل: `return_duration_minutes`
- مثال: 40 دقيقة
- **مطلوب**

**الفائدة:** يتم استخدام المدة للتحقق من توفر السيارة

---

### 4. التحقق من توفر السيارة

#### الميزة الجديدة الرئيسية: 

عند اختيار السيارة وإدخال أوقات الرحلة، يتم **التحقق التلقائي** من توفر السيارة!

#### كيف يعمل؟

1. **اختر السيارة**
2. **أدخل تاريخ ووقت الذهاب + المدة**
3. **أدخل تاريخ ووقت العودة + المدة**
4. **يظهر تنبيه فوري:**
   - ✅ "السيارة متاحة في هذا الوقت" (أخضر)
   - ❌ "السيارة محجوزة في هذا الوقت!" (أحمر)

#### التحقق يشمل:

**للذهاب:**
- الوقت: من `booking_from` إلى (`booking_from` + `trip_duration`)
- مثال: من 10:00 صباحاً إلى 10:40 صباحاً (40 دقيقة)

**للعودة:**
- الوقت: من `booking_to` إلى (`booking_to` + `return_duration_minutes`)
- مثال: من 02:00 مساءً إلى 02:40 مساءً (40 دقيقة)

#### إذا كانت السيارة محجوزة:

- **يظهر تنبيه:** يوضح وقت الحجز المتعارض ورقم الغرفة
- **يتم تعطيل زر الحفظ:** لمنع الحجز المزدوج
- **رسالة مفصلة:** 
  ```
  السيارة محجوزة في رحلة الذهاب من 2025-11-23 10:00 إلى 10:40 (الغرفة: 201)
  ```

---

### 5. المميزات الإضافية

#### 5.1 حساب تلقائي لوقت العودة المقترح
- عند إدخال وقت الذهاب والمدة
- يتم اقتراح وقت بداية العودة تلقائياً
- يمكن تعديله حسب الحاجة

#### 5.2 نسخ السائق تلقائياً
- عند اختيار سائق الذهاب
- يتم نسخه تلقائياً كسائق العودة
- يمكن تغييره إذا كان السائق مختلفاً

#### 5.3 تصميم أفضل
- خطوط فاصلة واضحة بين الأقسام
- ألوان مميزة لقسمي الذهاب والعودة:
  - الذهاب: خلفية زرقاء متدرجة
  - العودة: خلفية برتقالية متدرجة
- أيقونات معبرة لكل قسم

---

### 6. التغييرات في قاعدة البيانات

#### Migration جديدة:
```
2025_11_23_174953_add_route_fields_to_bookings_table.php
```

#### الحقول الجديدة في جدول `bookings`:

1. `trip_duration` (integer, nullable)
   - مدة رحلة الذهاب بالدقائق
   
2. `departure_route` (text, nullable)
   - نص التشغيلة للذهاب
   
3. `return_route` (text, nullable)
   - نص التشغيلة للعودة

---

### 7. التحديثات البرمجية

#### Models:
- تحديث `Booking` Model بإضافة الحقول الجديدة للـ `$fillable`

#### Requests:
- تحديث `StoreInternalBookingRequest`
- تحديث `UpdateInternalBookingRequest`
- الحقول الجديدة مطلوبة ماعدا `return_route`

#### Controllers:
- إضافة `Api/CarAvailabilityController` 
- يتعامل مع التحقق من توفر السيارة

#### Routes:
- إضافة endpoint جديد: `POST /api/check-car-availability`

---

### 8. مثال على سيناريو الحجز

#### الموقف:
- السيارة رقم 1 محجوزة لرحلة:
  - الذهاب: 23/11/2025 الساعة 10:00 صباحاً (مدة 40 دقيقة)
  - العودة: 23/11/2025 الساعة 02:00 مساءً (مدة 40 دقيقة)

#### سيناريو 1: محاولة حجز نفس السيارة
- الذهاب: 23/11/2025 الساعة 10:20 صباحاً
- **النتيجة:** ❌ مرفوض
- **السبب:** يتعارض مع الحجز الموجود (10:00 - 10:40)

#### سيناريو 2: حجز بعد انتهاء الرحلة
- الذهاب: 23/11/2025 الساعة 11:00 صباحاً
- **النتيجة:** ✅ مقبول
- **السبب:** الرحلة السابقة انتهت في 10:40

#### سيناريو 3: تعارض في العودة فقط
- الذهاب: 23/11/2025 الساعة 11:00 صباحاً ✅
- العودة: 23/11/2025 الساعة 02:15 مساءً ❌
- **النتيجة:** ❌ مرفوض
- **السبب:** العودة تتعارض مع رحلة موجودة (02:00 - 02:40)

---

### 9. التعليمات للمستخدم

#### خطوات الحجز:

1. **أدخل رقم الغرفة**
2. **اختر نوع السيارة والسيارة**
3. **املأ بيانات الذهاب:**
   - السائق
   - التاريخ والوقت
   - المدة (مثال: 40)
   - التشغيلة (مثال: من فندق هيلتون إلى المتحف)
4. **املأ عدد الأفراد**
5. **املأ بيانات العودة:**
   - سائق العودة (أو اتركه فارغاً لنفس السائق)
   - التاريخ والوقت
   - المدة
   - التشغيلة (اختياري)
6. **اختر نوع الدفع**
7. **أدخل المبالغ**
8. **تأكد من ظهور "✓ السيارة متاحة"**
9. **احفظ الحجز**

---

### 10. ملاحظات تقنية

#### API Response Format:

**نجاح (السيارة متاحة):**
```json
{
  "available": true,
  "message": "السيارة متاحة"
}
```

**فشل (السيارة محجوزة):**
```json
{
  "available": false,
  "message": "السيارة محجوزة في رحلة الذهاب من 2025-11-23 10:00 إلى 10:40 (الغرفة: 201)",
  "conflict": "departure"
}
```

#### التحقق يعمل على:
- الحجوزات الجديدة
- عند التعديل (يستثني الحجز الحالي من التحقق)

---

### 11. الإصلاحات والتحسينات

✅ فصل واضح بين أقسام الذهاب والعودة  
✅ التشغيلة كنص حر (أسهل وأسرع)  
✅ تسجيل مدة كل رحلة  
✅ التحقق التلقائي من توفر السيارة  
✅ منع الحجوزات المتعارضة  
✅ حساب تلقائي للأوقات المقترحة  
✅ تحسين تجربة المستخدم  
✅ تصميم أجمل مع ألوان مميزة  

---

**التاريخ:** 23 نوفمبر 2025  
**الإصدار:** 1.1  
**الحالة:** ✅ جاهز للاستخدام

